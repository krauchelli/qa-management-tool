name: Deploy to Staging Server
on:
  push:
    branches: [ staging ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Environment
        run: |
          echo "ğŸ” Environment Info:"
          echo "Docker version: $(docker --version)"
          echo "Docker Compose version: $(docker-compose --version)"

      - name: Stop Old Containers
        run: |
          docker-compose -f docker-compose.staging.yml down || true

      - name: Build and Start Services
        run: |
          echo "ğŸ—ï¸ Building and starting services..."
          docker-compose -f docker-compose.staging.yml build
          docker-compose -f docker-compose.staging.yml up -d

      - name: Wait for Services
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10

      - name: Check Import Script
        run: |
          echo "ğŸ“‹ Checking if import script exists..."
          if docker exec qa-tool-backend-staging test -f "scripts/import-from-markdown.ts"; then
            echo "âœ… Import script found"
            echo "ğŸ’¡ To import data, run: docker exec qa-tool-backend-staging npm run import"
          else
            echo "âš ï¸  Import script not found"
          fi

      - name: Show Status
        run: |
          echo ""
          echo "âœ… Deployment Complete (DEV MODE with Docker)!"
          echo ""
          docker-compose -f docker-compose.staging.yml ps
          echo ""
          echo "ğŸŒ Access:"
          echo "   Frontend: http://$(hostname -I | awk '{print $1}'):5173"
          echo "   Backend:  http://$(hostname -I | awk '{print $1}'):3000"
          echo ""
          echo "ğŸ“‹ Useful commands:"
          echo "   docker-compose -f docker-compose.staging.yml logs -f"
          echo "   docker-compose -f docker-compose.staging.yml restart"
          echo "   docker exec qa-tool-backend-staging npm run import"
