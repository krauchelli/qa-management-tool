name: Deploy to Staging Server
on:
  push:
    branches: [ staging ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Environment
        run: |
          echo "ğŸ” Checking environment..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "NVM version: $(nvm --version 2>/dev/null || echo 'not installed')"
          echo "PM2 installed: $(command -v pm2 &> /dev/null && echo 'yes' || echo 'no')"
          echo "Working directory: $(pwd)"

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          cd backend && npm install && cd ..
          cd frontend && npm install && cd ..

      - name: Build Frontend
        run: |
          echo "ğŸ—ï¸ Building frontend..."
          cd frontend
          npm run build
          cd ..

      - name: Build Backend
        run: |
          echo "ğŸ—ï¸ Building backend..."
          cd backend
          npm run build
          cd ..

      - name: Setup Database
        run: |
          echo "ğŸ—„ï¸ Setting up database..."
          cd backend
          npx prisma generate
          npx prisma migrate deploy || npx prisma db push
          cd ..

      - name: Install PM2 if needed
        run: |
          if ! command -v pm2 &> /dev/null; then
            echo "ï¿½ Installinsg PM2..."
            npm install -g pm2
          else
            echo "âœ… PM2 already installed: $(pm2 --version)"
          fi

      - name: Restart with PM2
        run: |
          echo "ğŸ”„ Restarting services..."
          
          # Stop and delete old processes
          pm2 stop qa-tool-backend || true
          pm2 stop qa-tool-frontend || true
          pm2 delete qa-tool-backend || true
          pm2 delete qa-tool-frontend || true
          
          # Start backend (port 3000)
          cd backend
          pm2 start npm --name "qa-tool-backend" --interpreter none -- start
          cd ..
          
          # Start frontend preview server (port 5174)
          cd frontend
          pm2 start npm --name "qa-tool-frontend" --interpreter none -- run preview -- --port 5174 --host
          cd ..
          
          # Save PM2 configuration
          pm2 save

      - name: Show Deployment Status
        run: |
          echo ""
          echo "âœ… Deployment Complete!"
          echo ""
          echo "ğŸ“Š PM2 Status:"
          pm2 list
          echo ""
          echo "ğŸŒ Access URLs:"
          echo "   Frontend: http://$(hostname -I | awk '{print $1}'):5174"
          echo "   Backend:  http://$(hostname -I | awk '{print $1}'):3000"
